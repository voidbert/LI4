@page "/Cliente/Carrinho"

@using LI4.Apresentacao.Componentes
@using LI4.Negocio
@using LI4.Negocio.Encomendas
@using LI4.Negocio.Utilizadores

@namespace LI4.Apresentacao.Paginas.Cliente

@inject ComumService ComumService
@inject EncomendasService EncomendasService
@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStorage
@inject UtilizadoresService UtilizadoresService

<Autorizador TipoDeConta=@Utilizador.Tipo.Cliente />
<Alerta @bind-Mensagem=@MensagemAlerta />

Carrinho de Compras

<table>
    <tr>
        <th>Item</th>
        <th>Preço</th>
        <th>Quantidade</th>
        <th>Total</th>
        <th></th>
    </tr>

    @foreach (EVA eva in EVAs)
    {
        <tr>
            <td>
                <img src="@eva.Imagem" asp-append-version="true" width="200rem" />
                @eva.Nome
            </td>
            <td>
                @String.Format("{0:F2} €", eva.Preco)
            </td>
            <td>
                <button @onclick="@(() => DecrementarQuantidade(eva))">-</button>
                @CarrinhoCompras!.ConteudoRaw.GetValueOrDefault(eva.Identificador, 0).ToString()
                <button @onclick="@(() => IncrementarQuantidade(eva))">+</button>
            </td>
            <td>
                @String.Format("{0:F2} €", eva.Preco * CarrinhoCompras!.ConteudoRaw[eva.Identificador])
            </td>
            <td>
                <button @onclick="@(() => RemoverEVA(eva))">Remover</button>
            </td>
        </tr>
    }

</table>

<a href="/Cliente">
    <button>Voltar</button>
</a>

<span>
    @String.Format("{0:F2} €", Preco)
</span>

<InputText placeholder="Morada" @bind-Value=@Morada />

<button @onclick=@FinalizarPedido>Finalizar Pedido</button>

@code
{
    private List<EVA> EVAs { get; set; } = new List<EVA>();

    private CarrinhoCompras? CarrinhoCompras { get; set; }
    private double Preco { get; set; }
    private string Morada { get; set; } = "";
    private string? MensagemAlerta { get; set; }

    private Utilizador? Cliente { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            SessaoController sessoes = new SessaoController(UtilizadoresService, ProtectedLocalStorage, NavigationManager);
            Cliente = await sessoes.ObterUtilizadorComSessaoIniciada();

            CarrinhoCompras = EncomendasService.ObterCarrinho(Cliente!.EnderecoEletronico);
            EVAs = CarrinhoCompras.Conteudo.Keys.ToList();
            EVAs.Sort((e1, e2) => e1.Nome.CompareTo(e2.Nome));

            Preco = CarrinhoCompras!.CalcularPreco();
            StateHasChanged();
        }
    }

    private void FinalizarPedido()
    {
        if (Morada == "")
        {
            MensagemAlerta = "Morada não pode estar vazia";
            return;
        }

        EncomendaEVAs encomenda = new EncomendaEVAs(Cliente!.EnderecoEletronico, Morada, Preco, DateTime.Now, CarrinhoCompras!.ConteudoRaw);
        try
        {
            EncomendasService.ColocarEncomenda(encomenda);
        }
        catch (CarrinhoVazioException)
        {
            MensagemAlerta = "Carrinho de compras não pode estar vazio";
            return;
        }

        CarrinhoCompras!.ConteudoRaw = new Dictionary<int, int>();
        EncomendasService.AtualizarCarrinho(CarrinhoCompras!);

        EVAs = new List<EVA>(); // Not to crash the renderer while the redirect isn't complete
        NavigationManager.NavigateTo("/Cliente");
    }

    private void IncrementarQuantidade(EVA eva)
    {
        int quantidade = CarrinhoCompras!.ConteudoRaw.GetValueOrDefault(eva.Identificador, 0);
        CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, quantidade + 1);
        EncomendasService.AtualizarCarrinho(CarrinhoCompras);
        Preco = CarrinhoCompras!.CalcularPreco();
    }

    private void DecrementarQuantidade(EVA eva)
    {
        int quantidade = CarrinhoCompras!.ConteudoRaw.GetValueOrDefault(eva.Identificador, 0);
        if (quantidade <= 1)
            return;

        CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, quantidade - 1);
        EncomendasService.AtualizarCarrinho(CarrinhoCompras);
        Preco = CarrinhoCompras!.CalcularPreco();
    }

    private void RemoverEVA(EVA eva)
    {
        CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, 0);
        EVAs.Remove(eva);
        EncomendasService.AtualizarCarrinho(CarrinhoCompras);
        Preco = CarrinhoCompras!.CalcularPreco();
    }
}
