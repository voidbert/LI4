@page "/Cliente/Carrinho"

@using LI4.Negocio
@using LI4.Negocio.Utilizadores
@using LI4.Negocio.Encomendas
@using LI4.Apresentacao.Componentes

@namespace LI4.Apresentacao.Paginas.Cliente

@inject UtilizadoresService UtilizadoresService
@inject ComumService ComumService
@inject EncomendasService EncomendasService
@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStorage

<main>
    <HeaderTitle>Carrinho de Compras</HeaderTitle>
    <table class="cart">
        <tr>
            <th>Item</th>
            <th>Preço</th>
            <th>Quantidade</th>
            <th>Total</th>
            <th></th>
        </tr>

        @foreach (EVA eva in EVAs)
        {
            <tr>
                <td class="eva">
                    <img src="@eva.Imagem" asp-append-version="true" width="200rem" />
                    <span>@eva.Nome</span>
                </td>
                <td>
                    @String.Format("{0:F2} €", eva.Preco)
                </td>
                <td>
                    <Counter Value="@CarrinhoCompras!.Conteudo.GetValueOrDefault(eva.Identificador, 0)" Decrementar="@(() => DecrementarQuantidade(eva))" Incrementar="@(() => IncrementarQuantidade(eva))"/>
                </td>
                <td>
                    @String.Format("{0:F2} €", eva.Preco * CarrinhoCompras!.Conteudo[eva.Identificador])
                </td>
                <td>
                    <XComp AoClicar="@(() => RemoverEVA(eva))" />
                </td>
            </tr>
        }
    </table>

    <div class="checkout-container">
        <!-- Row 1: Back Button -->
            <div class="left-button">
                <LinkButton Href="/Cliente" Title="Voltar" />
            </div>

        <!-- Row 2: Finalization Section -->
        <div class="finalization">
            <!-- Address Input -->
            <div class="address-input">
                <InputField Placeholder="Morada de Entrega" Value="@Morada" />
            </div>

            <!-- Final Price and Button -->
            <div class="finalization-details">
                <div class="final-price">
                    Preço Final: <span>@String.Format("{0:F2} €", Preco)</span>
                </div>
                <div class="finalize-button">
                    <ActionButton Callback="@FinalizarPedido" Title="Finalizar Pedido" />
                </div>
            </div>
        </div>
    </div>


</main>

@code {
    private List<EVA> EVAs { get; set; } = new List<EVA>();

    private CarrinhoCompras? CarrinhoCompras { get; set; }
    private double Preco { get; set; }
    private string Morada { get; set; } = "";

    private SessaoController? SessaoController { get; set; }
    private Utilizador? Cliente { get; set; }

    protected override void OnInitialized()
    {
        SessaoController = new SessaoController(UtilizadoresService, ProtectedLocalStorage, NavigationManager);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SessaoController!.RedirecionarConformeTipo(Utilizador.Tipo.Cliente);

            Cliente = await SessaoController!.GetUtilizadorComSessaoIniciada();

            CarrinhoCompras = await EncomendasService.ObterCarrinho(Cliente!.EnderecoEletronico);
            foreach (int identificadorEVA in CarrinhoCompras.Conteudo.Keys)
            {
                EVA? eva = await ComumService.ObterEVA(identificadorEVA);
                if (eva != null)
                {
                    EVAs.Add(eva);
                }
            }
            EVAs.Sort((e1, e2) => e1.Nome.CompareTo(e2.Nome));

            Preco = await CarrinhoCompras!.CalcularPreco();
            StateHasChanged();
        }
    }

    private async Task FinalizarPedido()
    {
        EncomendaEVAs encomenda = new EncomendaEVAs(Cliente!, Morada, Preco, DateTime.Now, CarrinhoCompras!.Conteudo);
        await EncomendasService.ColocarEncomenda(encomenda);

        foreach (EVA eva in EVAs)
        {
            CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, 0);
        }
        await EncomendasService.AtualizarCarrinho(CarrinhoCompras!);

        EVAs = new List<EVA>(); // Not to crash the renderer
        NavigationManager.NavigateTo("/Cliente");
    }

    private async Task IncrementarQuantidade(EVA eva)
    {
        int quantidade = CarrinhoCompras!.Conteudo.GetValueOrDefault(eva.Identificador, 0);
        CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, quantidade + 1);
        await EncomendasService.AtualizarCarrinho(CarrinhoCompras);
        Preco = await CarrinhoCompras!.CalcularPreco();
    }

    private async Task DecrementarQuantidade(EVA eva)
    {
        int quantidade = CarrinhoCompras!.Conteudo.GetValueOrDefault(eva.Identificador, 0);
        if (quantidade <= 1)
            return;

        CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, quantidade - 1);
        await EncomendasService.AtualizarCarrinho(CarrinhoCompras);
        Preco = await CarrinhoCompras!.CalcularPreco();
    }

    private async Task RemoverEVA(EVA eva)
    {
        CarrinhoCompras!.DefinirQuantidadeDeEVA(eva, 0);
        EVAs.Remove(eva);
        await EncomendasService.AtualizarCarrinho(CarrinhoCompras);
        Preco = await CarrinhoCompras!.CalcularPreco();
    }
}
