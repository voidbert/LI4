@page "/GestorDeProducao"

@using LI4.Negocio.Utilizadores
@using LI4.Apresentacao.Componentes

@namespace LI4.Apresentacao.Paginas.GestorDeProducao

@inject UtilizadoresService UtilizadoresService
@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStorage

<main>
    <HeaderTitle>Olá, @NomeCivil!</HeaderTitle>
    <LinkButton Href="/GestorDeProducao/Encomendas" Title="Gerir Encomendas"/>
    <LinkButton Href="/GestorDeProducao/Armazem" Title="Consultar Armazém"/>
    <LinkButton Href="/GestorDeProducao/Simulacao" Title="Simulação Gráfica"/>
    <LinkButton Href="/GestorDeProducao/Producao" Title="Ordernar Produção"/>
    <ActionButton Callback="@Logout" Title="Terminar Sessão"/>
</main>

@code {
    private String? NomeCivil { get; set; } = "";
    private SessaoController? SessaoController { get; set; }

    protected override void OnInitialized()
    {
        SessaoController = new SessaoController(UtilizadoresService, ProtectedLocalStorage, NavigationManager);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SessaoController!.RedirecionarConformeTipo(Utilizador.Tipo.GestorDeProducao);

            Utilizador? utilizador = await SessaoController!.GetUtilizadorComSessaoIniciada();
            if (utilizador == null)
            {
                return;
            }

            NomeCivil = utilizador.NomeCivil;
            StateHasChanged();
        }
    }

    private async Task Logout() {
        await SessaoController!.TerminarSessao();
        NavigationManager.NavigateTo("/");
    }
}
