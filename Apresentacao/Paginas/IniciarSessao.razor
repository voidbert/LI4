@page "/"

@using LI4.Apresentacao.Componentes
@using LI4.Negocio.Utilizadores

@namespace LI4.Apresentacao.Paginas

@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStorage
@inject UtilizadoresService UtilizadoresService

<Autorizador TipoDeConta=@null />
<Alerta @bind-Mensagem=@MensagemAlerta />

<div class="text-center">
    <EditForm Model="@FormModel" OnSubmit="@Autenticar" FormName="Autenticar">
        <InputText class="form-control" id="email" placeholder="Endereço eletrónico" @bind-Value=@FormModel!.EnderecoEletronico />
        <InputText type="password" class="form-control" id="password" placeholder="Palavra passe" @bind-Value=@FormModel!.PalavraPasse />

        <a href="/Cliente/CriarConta">
            <button>Registar-se</button>
        </a>

        <button type="submit" id="login">Iniciar Sessão</button>
    </EditForm>
</div>

@code
{
    private class CredenciaisModel
    {
        public string EnderecoEletronico { get; set; } = "";
        public string PalavraPasse { get; set; } = "";
    }

    [SupplyParameterFromForm]
    private CredenciaisModel? FormModel { get; set; }

    private SessaoController? SessaoController { get; set; }

    private string? MensagemAlerta { get; set; }

    protected override void OnInitialized()
    {
        FormModel ??= new CredenciaisModel();
        SessaoController = new SessaoController(UtilizadoresService, ProtectedLocalStorage, NavigationManager);
    }

    private async Task Autenticar()
    {
        if (FormModel!.EnderecoEletronico == "" || FormModel!.PalavraPasse == "")
        {
            MensagemAlerta = "Preencha o endereço eletrónico e a palavra passe";
            return;
        }

        try
        {
            await SessaoController!.IniciarSessao(FormModel!.EnderecoEletronico, FormModel!.PalavraPasse);
            await SessaoController!.RedirecionarConformeTipo(null);
        }
        catch (UtilizadorNaoEncontradoException)
        {
            MensagemAlerta = "Endereço eletrónico não encontrado";
            FormModel!.PalavraPasse = "";
        }
        catch (PalavraPasseIncorretaException)
        {
            MensagemAlerta = "Palavra passe incorreta";
            FormModel!.PalavraPasse = "";
        }
        catch (ImpedidoDeIniciarSessaoException)
        {
            MensagemAlerta = "Este utilizador foi eliminado";
            FormModel!.PalavraPasse = "";
        }
    }
}
